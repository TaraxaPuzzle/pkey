<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Taraxa Block Scanner | pkey.quest</title>
	<link rel="icon" type="image/png" href="favicon.png.png" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="icon" href="favicon.png" />
    <style>
      body {
        font-family: 'Segoe UI', sans-serif;
        background: linear-gradient(135deg, #0f172a, #1e293b);
      }
    </style>
  </head>
  <body class="text-white bg-gradient-to-br from-slate-900 to-gray-800">
   <div class="flex flex-col min-h-screen">
    <!-- Top Nav -->
    <header class="sticky top-0 z-20 backdrop-blur bg-white/5 border-b border-white/10 px-6 py-4 flex justify-between items-center">
      <div class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-cyan-400 to-blue-500">Taraxa Block Scanner</div>
    </header>

    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10 space-y-12">
      <!-- Metrics -->
      <section class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <div class="col-span-3 grid grid-cols-1 sm:grid-cols-3 gap-4">
          <div class="bg-white/5 hover:bg-white/10 p-5 rounded-xl border border-white/10 transition">
            <div class="text-xs uppercase text-gray-400">Unique Wallets</div>
            <div id="uawTotal" class="text-3xl font-bold text-blue-400 mt-1">--</div>
            <div id="uawRange" class="text-xs text-gray-500 mt-1">Last 24h</div>
          </div>
          <div class="bg-white/5 hover:bg-white/10 p-5 rounded-xl border border-white/10 transition">
            <div class="text-xs uppercase text-gray-400">TPS</div>
            <div id="tpsTotal" class="text-3xl font-bold text-green-400 mt-1">--</div>
            <div id="tpsRange" class="text-xs text-gray-500 mt-1">Last 24h</div>
          </div>
          <div class="bg-white/5 hover:bg-white/10 p-5 rounded-xl border border-white/10 transition">
            <div class="text-xs uppercase text-gray-400">Transactions</div>
            <div id="txcountTotal" class="text-3xl font-bold text-yellow-300 mt-1">--</div>
            <div class="text-xs text-gray-500 mt-1 flex gap-2 items-center">
            <span id="txcountRange">Last 24h</span>
            <button onclick="toggleTxRange()" class="text-blue-400 hover:text-blue-200 underline ml-2">30d</button>
          </div>
          </div>
        </div>
        <!-- Live Widget -->
        <div class="bg-gradient-to-br from-red-500/10 via-white/5 to-white/5 p-4 rounded-xl border border-white/10 space-y-2 text-sm">
          <div class="flex items-center gap-2 text-red-400 font-semibold">
            <span class="h-2 w-2 rounded-full bg-red-500 animate-ping"></span>
            LIVE
          </div>
          <div class="grid grid-cols-2 gap-2 text-gray-300">
            <div><span class="text-gray-500">Block:</span> <span id="latestBlockNumber">--</span></div>
            <div><span class="text-gray-500">Txs:</span> <span id="latestBlockTxs">--</span></div>
            <div class="col-span-2"><span class="text-gray-500">Time:</span> <span id="latestBlockTimestamp">--</span></div>
            <div><span class="text-gray-500">Ago:</span> <span id="latestBlockTimeAgo">--</span></div>
            <div><span class="text-gray-500">TPS:</span> <span id="liveTPS">--</span></div>
          </div>
        </div>
      </section>

      <!-- Chart + Table -->
      <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white/5 p-6 rounded-xl border border-white/10">
          <div class="flex justify-between items-center mb-4">
            <h2 id="chartTitle" class="text-lg font-semibold">Activity Chart</h2>
            <div class="space-x-2">
              <button id="btn-uaw" onclick="showDataset('uaw')" class="px-3 py-1.5 rounded bg-blue-600 hover:bg-blue-700 transition">UAW</button>
              <button id="btn-txcount" onclick="showDataset('txcount')" class="px-3 py-1.5 rounded bg-gray-700 hover:bg-gray-600 transition">TX Count</button>
            </div>
          </div>
          <canvas id="activityChart" class="w-full h-64"></canvas>
        </div>

        <div class="bg-white/5 p-6 rounded-xl border border-white/10">
          <h2 class="text-lg font-semibold mb-4">Latest Transactions</h2>
          <div class="overflow-x-auto text-sm">
            <table class="min-w-full">
              <thead class="text-gray-400 border-b border-gray-700">
                <tr>
                  <th class="py-2 text-left">Time</th>
                  <th class="py-2 text-left">From</th>
                  <th class="py-2 text-left">To</th>
                  <th class="py-2 text-left">Hash</th>
                </tr>
              </thead>
              <tbody id="txHistoryTable" class="divide-y divide-gray-800">
                <tr id="loadingRow">
                  <td colspan="4" class="py-4 text-center text-gray-500 flex justify-center items-center gap-2">
                    <div class="h-2 w-2 rounded-full bg-blue-400 animate-ping"></div>
                    Loading latest transactions...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <footer class="w-full text-center text-sm text-gray-500 py-4 bg-white/5 border-t border-white/10">
      Made with üíô by <a href="https://pkey.quest" class="underline hover:text-white">pkey.quest</a>
    </footer>
	  
	  </div>
    </main>


  <script>
    let txHistory = [];
    let summaryStats = {};
    let currentRange = '24h';
    let currentDataset = 'uaw';
	let cachedTxHistory = [];
	let lastLiveTPS = null;
	let using30d = false;

    const chartData = {
  labels: [],
  datasets: {
    uaw: {
      label: 'Unique Active Wallets',
      data: [],
      backgroundColor: '#3b82f6'
    },
    txcount: {
      label: 'Transaction Count',
      data: [],
      backgroundColor: '#10b981'
    }
  }
};

    const ctx = document.getElementById('activityChart').getContext('2d');
    const activityChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: chartData.labels,
        datasets: [chartData.datasets[currentDataset]]
      },
      options: {
        responsive: true,
        scales: { y: { beginAtZero: true } }
      }
    });

function showDataset(key) {
      currentDataset = key;
      activityChart.data.datasets = [chartData.datasets[key]];
      activityChart.update();

      ['uaw', 'txcount'].forEach(type => {
        const btn = document.getElementById(`btn-${type}`);
        if (type === key) {
          btn.classList.add("bg-blue-500", "text-white");
          btn.classList.remove("bg-gray-200", "text-gray-800");
        } else {
          btn.classList.add("bg-gray-200", "text-gray-800");
          btn.classList.remove("bg-blue-500", "text-white");
        }
      });
    }

async function updateSummary(range) {
  currentRange = range;

  try {
    const res = await fetch('https://tarablockscanner-production.up.railway.app/daily_activity.json');
    summaryStats = await res.json();
    const stats = summaryStats[range];
    if (!stats) return;

    if (stats.chart) {
      chartData.labels = stats.chart.labels;
      chartData.datasets.uaw.data = stats.chart.uaw;
      chartData.datasets.txcount.data = stats.chart.txcount;
      activityChart.data.labels = chartData.labels;
      activityChart.data.datasets = [chartData.datasets[currentDataset]];
      activityChart.update();
    }

    document.getElementById("uawTotal").textContent = stats.uaw.toLocaleString();
    document.getElementById("tpsTotal").textContent = stats.tps.toFixed(2);
    document.getElementById("txcountTotal").textContent = stats.txcount.toLocaleString();

    document.getElementById("uawRange").textContent = "Last 24h";
    document.getElementById("tpsRange").textContent = "Last 24h";
    document.getElementById("txcountRange").textContent = "Last 24h";
    document.getElementById("chartTitle").textContent = "Activity Chart - Last 24h";
  } catch (err) {
    console.error("Failed to update summary:", err);
  }
}

async function renderTxHistory() {
  try {
    const res = await fetch('https://tarablockscanner-production.up.railway.app/tx_latest.json');
    const newHistory = await res.json();

    const latestTxHash = txHistory.length > 0 ? txHistory[txHistory.length - 1].tx_hash : null;
    const newLatestTxHash = newHistory.length > 0 ? newHistory[newHistory.length - 1].tx_hash : null;

    if (latestTxHash === newLatestTxHash) return; // No update needed

    txHistory = newHistory;
    cachedTxHistory = [...newHistory]; // Cache successful fetch

  } catch (err) {
    console.warn("‚ö†Ô∏è Failed to fetch latest tx history. Using cached data.");
    if (cachedTxHistory.length === 0) return; // No cache available
    txHistory = [...cachedTxHistory];
  }

  const tableBody = document.getElementById("txHistoryTable");
  if (!tableBody) {
    console.warn("‚ö†Ô∏è txHistoryTable element not found.");
    return;
  }

  // Remove loading row if still present
const loadingRow = document.getElementById("loadingRow");
if (loadingRow) loadingRow.remove();

  const frag = document.createDocumentFragment();

  txHistory.reverse().forEach(tx => {
    const time = new Date(tx.timestamp * 1000).toISOString().split("T")[1].slice(0, 8) + ' UTC';
    const fromShort = `${tx.from.slice(0, 6)}...${tx.from.slice(-4)}`;
    const toShort = `${tx.to.slice(0, 6)}...${tx.to.slice(-4)}`;
    const hashShort = `${tx.tx_hash.slice(0, 10)}...`;

    const row = document.createElement("tr");
    row.className = "border-b border-gray-700 hover:bg-gray-700/10 transition";

    row.innerHTML = `
      <td class="pr-4 py-2 whitespace-nowrap text-gray-300">${time}</td>
      <td class="pr-4 py-2 break-all">
        <a href="https://tara.to/address/${tx.from}" class="text-blue-400 hover:underline" title="${tx.from}" target="_blank">${fromShort}</a>
      </td>
      <td class="pr-4 py-2 break-all">
        <a href="https://tara.to/address/${tx.to}" class="text-green-400 hover:underline" title="${tx.to}" target="_blank">${toShort}</a>
      </td>
      <td class="pr-4 py-2 break-all">
        <a href="https://tara.to/tx/${tx.tx_hash}" class="text-yellow-300 hover:underline" title="${tx.tx_hash}" target="_blank">${hashShort}</a>
      </td>
    `;

    frag.appendChild(row);
  });

  tableBody.innerHTML = ""; // Clear previous content
  tableBody.appendChild(frag);
}

function loadLatestBlock() {
  fetch('https://tarablockscanner-production.up.railway.app/live_ticker.json')
    .then(res => res.json())
    .then(data => {
      document.getElementById("latestBlockNumber").textContent = data.block_number || '--';
      document.getElementById("latestBlockTxs").textContent = data.tx_count || '--';

      const date = new Date(data.timestamp * 1000);
      document.getElementById("latestBlockTimestamp").textContent = date.toISOString().replace('T', ' ').slice(0, 19) + ' UTC';

      const seconds = data.time_ago || 0;
      const timeStr = seconds < 60
        ? `${seconds}s ago`
        : seconds < 3600
          ? `${Math.floor(seconds / 60)}m ago`
          : `${Math.floor(seconds / 3600)}h ago`;
      document.getElementById("latestBlockTimeAgo").textContent = timeStr;

      // ‚úÖ Safe & stable TPS update
      if (typeof data.realtime_tps === 'number') {
        const currentTPS = data.realtime_tps.toFixed(2);
        if (String(currentTPS) !== String(lastLiveTPS)) {
          document.getElementById("liveTPS").textContent = currentTPS;
          lastLiveTPS = currentTPS;
        }
      } else {
        document.getElementById("liveTPS").textContent = '--';
        lastLiveTPS = null;
      }
    })
    .catch(err => console.error("Block fetch error", err));
}

async function initializeDashboard() {
  try {
    renderTxHistory();
    loadLatestBlock();
    setInterval(() => {
      loadLatestBlock();
      updateSummary(currentRange);
      renderTxHistory();
    }, 500);
  } catch (err) {
    console.error("Initialization failed:", err);
  }
}
initializeDashboard();

async function toggleTxRange() {
  using30d = !using30d;
  const label = document.getElementById("txcountRange");
  const btn = event.target;

  if (using30d) {
    try {
      const res = await fetch("https://tarablockscanner-production.up.railway.app/safe_state_30days.json");
      const data = await res.json();
      const totalTx = Object.values(data).reduce((sum, v) => sum + v, 0);

      label.textContent = "Last 30d";
      document.getElementById("txcountTotal").textContent = totalTx.toLocaleString();
      btn.textContent = "24h";

    } catch (err) {
      console.error("‚ö†Ô∏è Failed to load 30d data", err);
    }
  } else {
    // Reset to default 24h summary
    updateSummary("24h");
    btn.textContent = "30d";
  }
}
	
  </script>
  
</body>
</html>
