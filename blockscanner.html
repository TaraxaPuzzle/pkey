<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Taraxa Block Scanner Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-white">
  <div class="max-w-6xl mx-auto p-6">
    <h1 class="text-3xl font-bold mb-6">Taraxa Block Scanner</h1>

    <!-- Range Selector -->
    <div class="flex space-x-2 mb-6">
      <button onclick="updateSummary('24h')" class="range-btn px-4 py-2 font-medium bg-blue-500 text-white rounded">24h</button>
      <button onclick="updateSummary('7d')" class="range-btn px-4 py-2 font-medium bg-gray-200 text-gray-800 rounded">7d</button>
      <button onclick="updateSummary('30d')" class="range-btn px-4 py-2 font-medium bg-gray-200 text-gray-800 rounded">30d</button>
    </div>
	
<!-- Compact Latest Block Display with LIVE Indicator -->
<div class="bg-white dark:bg-gray-800 rounded-xl px-6 py-4 shadow flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6 border-l-4 border-red-500 relative">

  <!-- LIVE Dot -->
  <div class="absolute top-3 left-4 flex items-center gap-2">
    <div class="h-2.5 w-2.5 rounded-full bg-red-500 animate-ping"></div>
    <span class="text-xs font-semibold text-red-500">LIVE</span>
  </div>

  <!-- Block Info -->
  <div class="pl-20 sm:pl-24 flex flex-wrap gap-6 sm:gap-10 text-sm text-gray-800 dark:text-gray-100">
    <div><strong>Block:</strong> <span id="latestBlockNumber">--</span></div>
    <div><strong>TXs:</strong> <span id="latestBlockTxs">--</span></div>
    <div><strong>Timestamp:</strong> <span id="latestBlockTimestamp">--</span></div>
    <div><strong>⏱️ Ago:</strong> <span id="latestBlockTimeAgo">--</span></div>
  </div>

</div>


    <!-- Summary Section -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
      <div class="bg-white dark:bg-gray-800 rounded-xl p-5 shadow">
        <h2 class="text-lg font-semibold mb-2">Unique Active Wallets</h2>
        <p id="uawTotal" class="text-2xl font-bold">--</p>
        <span id="uawRange" class="text-sm text-gray-500">Last 24h</span>
      </div>
      <div class="bg-white dark:bg-gray-800 rounded-xl p-5 shadow">
        <h2 class="text-lg font-semibold mb-2">TPS</h2>
        <p id="tpsTotal" class="text-2xl font-bold">--</p>
        <span id="tpsRange" class="text-sm text-gray-500">Last 24h</span>
      </div>
      <div class="bg-white dark:bg-gray-800 rounded-xl p-5 shadow">
        <h2 class="text-lg font-semibold mb-2">Transaction Count</h2>
        <p id="txcountTotal" class="text-2xl font-bold">--</p>
        <span id="txcountRange" class="text-sm text-gray-500">Last 24h</span>
      </div>
    </div>

    <!-- Chart Section -->
    <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow mb-10">
      <h2 id="chartTitle" class="text-xl font-semibold mb-4">Activity Chart - Last 24h</h2>
      <div class="mb-4 flex">
        <button id="btn-uaw" onclick="showDataset('uaw')" class="px-4 py-2 font-medium rounded-l bg-blue-500 text-white">UAW</button>
        <button id="btn-txcount" onclick="showDataset('txcount')" class="px-4 py-2 font-medium rounded-r bg-gray-200 text-gray-800">TX Count</button>
      </div>
      <canvas id="activityChart" class="w-full h-96"></canvas>
    </div>

    <!-- Latest Transactions Table -->
    <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow mb-10">
      <h2 class="text-xl font-semibold mb-4">Latest Transactions</h2>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm text-left text-gray-300">
          <thead>
            <tr class="border-b border-gray-600 text-gray-400">
              <th class="pr-4 py-2">Time</th>
              <th class="pr-4 py-2">From</th>
              <th class="pr-4 py-2">To</th>
              <th class="pr-4 py-2">TX Hash</th>
            </tr>
          </thead>
          <tbody id="txHistoryTable">
            <!-- Filled dynamically -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    let txHistory = [];
    let summaryStats = {};
    let currentRange = '24h';
    let currentDataset = 'uaw';

    const chartData = {
  labels: [],
  datasets: {
    uaw: {
      label: 'Unique Active Wallets',
      data: [],
      backgroundColor: '#3b82f6'
    },
    txcount: {
      label: 'Transaction Count',
      data: [],
      backgroundColor: '#10b981'
    }
  }
};

    const ctx = document.getElementById('activityChart').getContext('2d');
    const activityChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: chartData.labels,
        datasets: [chartData.datasets[currentDataset]]
      },
      options: {
        responsive: true,
        scales: { y: { beginAtZero: true } }
      }
    });

    function showDataset(key) {
      currentDataset = key;
      activityChart.data.datasets = [chartData.datasets[key]];
      activityChart.update();

      ['uaw', 'txcount'].forEach(type => {
        const btn = document.getElementById(`btn-${type}`);
        if (type === key) {
          btn.classList.add("bg-blue-500", "text-white");
          btn.classList.remove("bg-gray-200", "text-gray-800");
        } else {
          btn.classList.add("bg-gray-200", "text-gray-800");
          btn.classList.remove("bg-blue-500", "text-white");
        }
      });
    }

    function updateSummary(range) {
      currentRange = range;
      const stats = summaryStats[range];
	  if (!stats) return;
	  if (stats.chart) {
  chartData.labels = stats.chart.labels;
  chartData.datasets.uaw.data = stats.chart.uaw;
  chartData.datasets.txcount.data = stats.chart.txcount;
  activityChart.data.labels = chartData.labels;
  activityChart.data.datasets = [chartData.datasets[currentDataset]];
  activityChart.update();
}

      document.getElementById("uawTotal").textContent = stats.uaw.toLocaleString();
      document.getElementById("tpsTotal").textContent = stats.tps.toFixed(2);
      document.getElementById("txcountTotal").textContent = stats.txcount.toLocaleString();

      document.getElementById("uawRange").textContent = `Last ${range}`;
      document.getElementById("tpsRange").textContent = `Last ${range}`;
      document.getElementById("txcountRange").textContent = `Last ${range}`;
      document.getElementById("chartTitle").textContent = `Activity Chart - Last ${range}`;

      document.querySelectorAll(".range-btn").forEach(btn => {
        if (btn.textContent === range) {
          btn.classList.add("bg-blue-500", "text-white");
          btn.classList.remove("bg-gray-200", "text-gray-800");
        } else {
          btn.classList.add("bg-gray-200", "text-gray-800");
          btn.classList.remove("bg-blue-500", "text-white");
        }
      });
    }

    function renderTxHistory() {
      if (!Array.isArray(txHistory) || txHistory.length === 0) return;
      const table = document.getElementById("txHistoryTable");
      table.innerHTML = "";

      txHistory.slice(-10).reverse().forEach(tx => {
        const time = new Date(tx.timestamp * 1000).toLocaleTimeString();
        const row = document.createElement("tr");
        row.className = "border-b border-gray-700 hover:bg-gray-700/20";
        row.innerHTML = `
          <td class="pr-4 py-1 whitespace-nowrap">${time}</td>
          <td class="pr-4 py-1 break-all text-blue-400">${tx.from.slice(0, 6)}...${tx.from.slice(-4)}</td>
          <td class="pr-4 py-1 break-all text-green-400">${tx.to.slice(0, 6)}...${tx.to.slice(-4)}</td>
          <td class="pr-4 py-1 break-all">${tx.tx_hash.slice(0, 10)}...</td>
        `;
        table.appendChild(row);
      });
    }

    function loadLatestBlock() {
      fetch('https://tarablockscanner-production.up.railway.app/latest_block')
        .then(res => res.json())
        .then(data => {
          document.getElementById("latestBlockNumber").textContent = data.block_number || '--';
          document.getElementById("latestBlockTxs").textContent = data.tx_count || '--';

          const date = new Date(data.timestamp * 1000);
          document.getElementById("latestBlockTimestamp").textContent = date.toLocaleString();

          const seconds = data.time_ago || 0;
          let timeStr = seconds < 60
            ? `${seconds}s ago`
            : seconds < 3600
              ? `${Math.floor(seconds / 60)}m ago`
              : `${Math.floor(seconds / 3600)}h ago`;
          document.getElementById("latestBlockTimeAgo").textContent = timeStr;
        })
        .catch(err => console.error("Block fetch error", err));
    }

    async function initializeDashboard() {
      try {
        const [statsRes, txRes] = await Promise.all([
          fetch('https://tarablockscanner-production.up.railway.app/daily_activity.json'),
          fetch('https://tarablockscanner-production.up.railway.app/tx_history.json')
        ]);
        summaryStats = await statsRes.json();
        txHistory = await txRes.json();

        updateSummary('24h');
        renderTxHistory();
        loadLatestBlock();
        setInterval(loadLatestBlock, 10000);
      } catch (err) {
        console.error("Initialization failed:", err);
      }
    }

    initializeDashboard();
  </script>
</body>
</html>
