<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Taraxa Scanner | pkey.quest</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="icon" href="favicon.png" />
    <style>
      body {
        font-family: 'Segoe UI', sans-serif;
        background: #0f172a;
      }
      .glass {
        @apply bg-white/5 backdrop-blur-md border border-white/10;
      }
    </style>
  </head>
  <body class="text-white min-h-screen">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10 space-y-12">
      <header class="text-center">
        <h1 class="text-4xl sm:text-5xl font-extrabold tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-blue-500 to-cyan-400">
          Taraxa Block Scanner
        </h1>
        <p class="text-gray-400 mt-2">By <span class="font-semibold text-white">pkey.quest</span></p>
      </header>

      <section class="grid grid-cols-1 sm:grid-cols-3 gap-6">
        <div class="glass p-6 rounded-2xl shadow-lg">
          <h2 class="text-sm font-medium text-gray-400">Unique Wallets</h2>
          <p id="uawTotal" class="text-3xl font-semibold text-blue-400">--</p>
          <p id="uawRange" class="text-xs text-gray-500 mt-1">Last 24h</p>
        </div>
        <div class="glass p-6 rounded-2xl shadow-lg">
          <h2 class="text-sm font-medium text-gray-400">TPS</h2>
          <p id="tpsTotal" class="text-3xl font-semibold text-green-400">--</p>
          <p id="tpsRange" class="text-xs text-gray-500 mt-1">Last 24h</p>
        </div>
        <div class="glass p-6 rounded-2xl shadow-lg">
          <h2 class="text-sm font-medium text-gray-400">Transactions</h2>
          <p id="txcountTotal" class="text-3xl font-semibold text-yellow-300">--</p>
          <p id="txcountRange" class="text-xs text-gray-500 mt-1">Last 24h</p>
        </div>
      </section>

<!-- Floating Live Stats Panel -->
<div class="fixed bottom-6 right-6 z-50">
  <div class="flex items-center gap-2 text-xs px-3 py-1 rounded-full bg-red-500/10 text-red-400 backdrop-blur-sm border border-red-500/20 shadow-sm mb-1">
    <div class="h-2 w-2 rounded-full bg-red-500 animate-ping"></div>
    LIVE
  </div>
  <div class="glass p-4 rounded-xl shadow-xl grid grid-cols-2 sm:grid-cols-2 gap-3 text-xs sm:text-sm w-[280px]">
    <div><span class="text-gray-400">Block:</span> <span id="latestBlockNumber">--</span></div>
    <div><span class="text-gray-400">TXs:</span> <span id="latestBlockTxs">--</span></div>
    <div><span class="text-gray-400">Timestamp:</span> <span id="latestBlockTimestamp">--</span></div>
    <div><span class="text-gray-400">Ago:</span> <span id="latestBlockTimeAgo">--</span></div>
    <div class="col-span-2"><span class="text-gray-400">Real-Time TPS:</span> <span id="liveTPS">--</span></div>
  </div>
</div>

      <section class="glass p-6 rounded-2xl shadow-xl">
        <div class="flex justify-between items-center mb-4">
          <h2 id="chartTitle" class="text-lg font-semibold">Activity Chart - Last 24h</h2>
          <div class="flex rounded overflow-hidden border border-white/10">
            <button id="btn-uaw" onclick="showDataset('uaw')" class="px-4 py-1.5 bg-blue-600 hover:bg-blue-700 transition">UAW</button>
            <button id="btn-txcount" onclick="showDataset('txcount')" class="px-4 py-1.5 bg-gray-700 hover:bg-gray-600 transition">TX Count</button>
          </div>
        </div>
        <canvas id="activityChart" class="w-full h-80"></canvas>
      </section>

      <section class="glass p-6 rounded-2xl shadow-xl">
        <h2 class="text-lg font-semibold mb-4">Latest Transactions</h2>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead>
              <tr class="text-gray-400 border-b border-gray-700">
                <th class="py-2 text-left">Time</th>
                <th class="py-2 text-left">From</th>
                <th class="py-2 text-left">To</th>
                <th class="py-2 text-left">Hash</th>
              </tr>
            </thead>
            <tbody id="txHistoryTable" class="divide-y divide-gray-800">
              <!-- Dynamically filled -->
            </tbody>
          </table>
        </div>
      </section>

      <footer class="pt-10 text-center text-sm text-gray-500">
        Made with 💙 by <a href="https://pkey.quest" class="underline hover:text-white">pkey.quest</a>
      </footer>
    </div>

  <script>
    let txHistory = [];
    let summaryStats = {};
    let currentRange = '24h';
    let currentDataset = 'uaw';
	let cachedTxHistory = [];

    const chartData = {
  labels: [],
  datasets: {
    uaw: {
      label: 'Unique Active Wallets',
      data: [],
      backgroundColor: '#3b82f6'
    },
    txcount: {
      label: 'Transaction Count',
      data: [],
      backgroundColor: '#10b981'
    }
  }
};

    const ctx = document.getElementById('activityChart').getContext('2d');
    const activityChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: chartData.labels,
        datasets: [chartData.datasets[currentDataset]]
      },
      options: {
        responsive: true,
        scales: { y: { beginAtZero: true } }
      }
    });

function showDataset(key) {
      currentDataset = key;
      activityChart.data.datasets = [chartData.datasets[key]];
      activityChart.update();

      ['uaw', 'txcount'].forEach(type => {
        const btn = document.getElementById(`btn-${type}`);
        if (type === key) {
          btn.classList.add("bg-blue-500", "text-white");
          btn.classList.remove("bg-gray-200", "text-gray-800");
        } else {
          btn.classList.add("bg-gray-200", "text-gray-800");
          btn.classList.remove("bg-blue-500", "text-white");
        }
      });
    }

async function updateSummary(range) {
  currentRange = range;

  try {
    const res = await fetch('https://tarablockscanner-production.up.railway.app/daily_activity.json');
    summaryStats = await res.json();
    const stats = summaryStats[range];
    if (!stats) return;

    if (stats.chart) {
      chartData.labels = stats.chart.labels;
      chartData.datasets.uaw.data = stats.chart.uaw;
      chartData.datasets.txcount.data = stats.chart.txcount;
      activityChart.data.labels = chartData.labels;
      activityChart.data.datasets = [chartData.datasets[currentDataset]];
      activityChart.update();
    }

    document.getElementById("uawTotal").textContent = stats.uaw.toLocaleString();
    document.getElementById("tpsTotal").textContent = stats.tps.toFixed(2);
    document.getElementById("txcountTotal").textContent = stats.txcount.toLocaleString();

    document.getElementById("uawRange").textContent = "Last 24h";
    document.getElementById("tpsRange").textContent = "Last 24h";
    document.getElementById("txcountRange").textContent = "Last 24h";
    document.getElementById("chartTitle").textContent = "Activity Chart - Last 24h";
  } catch (err) {
    console.error("Failed to update summary:", err);
  }
}


let cachedTxHistory = [];

async function renderTxHistory() {
  try {
    const res = await fetch('https://tarablockscanner-production.up.railway.app/tx_history.json');
    const newHistory = await res.json();

    const latestTxHash = txHistory.length > 0 ? txHistory[txHistory.length - 1].tx_hash : null;
    const newLatestTxHash = newHistory.length > 0 ? newHistory[newHistory.length - 1].tx_hash : null;

    if (latestTxHash === newLatestTxHash) return; // No update needed

    txHistory = newHistory;
    cachedTxHistory = [...newHistory]; // Cache successful fetch

  } catch (err) {
    console.warn("⚠️ Failed to fetch latest tx history. Using cached data.");
    if (cachedTxHistory.length === 0) return; // No cache available
    txHistory = [...cachedTxHistory];
  }

  const tableBody = document.getElementById("txHistoryTable");
  if (!tableBody) {
    console.warn("⚠️ txHistoryTable element not found.");
    return;
  }

  const frag = document.createDocumentFragment();

  txHistory.slice(-10).reverse().forEach(tx => {
    const time = new Date(tx.timestamp * 1000).toISOString().split("T")[1].slice(0, 8) + ' UTC';
    const fromShort = `${tx.from.slice(0, 6)}...${tx.from.slice(-4)}`;
    const toShort = `${tx.to.slice(0, 6)}...${tx.to.slice(-4)}`;
    const hashShort = `${tx.tx_hash.slice(0, 10)}...`;

    const row = document.createElement("tr");
    row.className = "border-b border-gray-700 hover:bg-gray-700/10 transition";

    row.innerHTML = `
      <td class="pr-4 py-2 whitespace-nowrap text-gray-300">${time}</td>
      <td class="pr-4 py-2 break-all">
        <a href="https://tara.to/address/${tx.from}" class="text-blue-400 hover:underline" title="${tx.from}" target="_blank">${fromShort}</a>
      </td>
      <td class="pr-4 py-2 break-all">
        <a href="https://tara.to/address/${tx.to}" class="text-green-400 hover:underline" title="${tx.to}" target="_blank">${toShort}</a>
      </td>
      <td class="pr-4 py-2 break-all">
        <a href="https://tara.to/tx/0x${tx.tx_hash}" class="text-yellow-300 hover:underline" title="0x${tx.tx_hash}" target="_blank">${hashShort}</a>
      </td>
    `;

    frag.appendChild(row);
  });

  tableBody.innerHTML = ""; // Clear previous content
  tableBody.appendChild(frag);
}

function loadLatestBlock() {
  fetch('https://tarablockscanner-production.up.railway.app/latest_block')
    .then(res => res.json())
    .then(data => {
      document.getElementById("latestBlockNumber").textContent = data.block_number || '--';
      document.getElementById("latestBlockTxs").textContent = data.tx_count || '--';

      const date = new Date(data.timestamp * 1000);
      document.getElementById("latestBlockTimestamp").textContent = date.toISOString().replace('T', ' ').slice(0, 19) + ' UTC';

      const seconds = data.time_ago || 0;
      let timeStr = seconds < 60
        ? `${seconds}s ago`
        : seconds < 3600
          ? `${Math.floor(seconds / 60)}m ago`
          : `${Math.floor(seconds / 3600)}h ago`;
      document.getElementById("latestBlockTimeAgo").textContent = timeStr;
    })
    .catch(err => console.error("Block fetch error", err));

  // ⏱️ Fetch Realtime TPS
  fetch('https://tarablockscanner-production.up.railway.app/daily_activity.json')
    .then(res => res.json())
    .then(stats => {
      const tps = stats.realtime_tps;
      if (typeof tps !== 'undefined') {
        document.getElementById("liveTPS").textContent = tps.toFixed(2);
      } else {
        document.getElementById("liveTPS").textContent = '--';
      }
    })
    .catch(err => console.error("TPS fetch error", err));
}


async function initializeDashboard() {
      try {
        const [statsRes, txRes] = await Promise.all([
          fetch('https://tarablockscanner-production.up.railway.app/daily_activity.json'),
          fetch('https://tarablockscanner-production.up.railway.app/tx_history.json')
        ]);
        summaryStats = await statsRes.json();
        txHistory = await txRes.json();

        updateSummary('24h');
        renderTxHistory();
        loadLatestBlock();
        setInterval(() => {
         loadLatestBlock();
         updateSummary(currentRange);
         renderTxHistory();
    }, 500);
      } catch (err) {
        console.error("Initialization failed:", err);
      }
    }

    initializeDashboard();
	
  </script>
  
</body>
</html>
