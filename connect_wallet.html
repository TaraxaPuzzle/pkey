<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Enkrypt Wallet Connect Demo</title>
<script src="https://cdn.jsdelivr.net/npm/ethers@6.8.1/dist/ethers.umd.min.js"></script>
<script src="https://unpkg.com/@web3modal/html@2.3.4/dist/index.min.js"></script>
<script src="https://unpkg.com/@web3modal/ethereum@2.3.4/dist/index.min.js"></script>
</head>
<body>
<button id="connectBtn">Connect Wallet</button>
<div id="walletAddress"></div>

<script>
  const chains = [
    {
      id: 841,
      name: "Taraxa Mainnet",
      network: "taraxa",
      nativeCurrency: { decimals: 18, name: "Tara", symbol: "TARA" },
      rpcUrls: { default: ["https://rpc.mainnet.taraxa.io"] },
      blockExplorers: { default: { name: "Taraxa Explorer", url: "https://explorer.mainnet.taraxa.io" } }
    }
  ];

  const projectId = "c3bca9309d970d96c70be0b04f661798";

  // Web3Modal + WalletConnect v2 setup
  const web3modalEthereum = new Web3ModalEthereum({
    projectId,
    chains
  });
  const web3modal = new Web3Modal({
    ethereum: web3modalEthereum,
    themeMode: "light"
  });

  let provider, signer;

  async function connectWallet() {
    try {
      if (window.enkrypt?.ethereum) {
        // Use Enkrypt injected provider directly
        provider = new ethers.BrowserProvider(window.enkrypt.ethereum);
        console.log("Using Enkrypt injected provider");
      } else if (window.ethereum && window.ethereum.isEnkrypt) {
        provider = new ethers.BrowserProvider(window.ethereum);
        console.log("Using Enkrypt provider via window.ethereum");
      } else {
        // Fallback to Web3Modal wallet selector (includes Enkrypt via WalletConnect)
        await web3modal.openModal();
        provider = new ethers.BrowserProvider(web3modalEthereum);
        console.log("Using Web3Modal WalletConnect provider");
      }

      await provider.send("eth_requestAccounts", []);
      signer = await provider.getSigner();
      const address = await signer.getAddress();
      document.getElementById("walletAddress").innerText = "Connected wallet: " + address;
      console.log("Connected wallet:", address);

    } catch (err) {
      console.error("Connection failed:", err);
      alert("Failed to connect wallet");
    }
  }

  document.getElementById("connectBtn").onclick = connectWallet;
</script>
</body>
</html>
