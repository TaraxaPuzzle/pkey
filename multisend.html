<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Multisend Tool</title>
  <link rel="icon" type="image/png" href="favicon.png.png" />
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.8.1/dist/ethers.umd.min.js">
  </script>
  <script>
async function setupTaraxaNetwork() {
  const TARAXA_MAIN = {
    chainId: '0x349',
    chainName: 'Taraxa Mainnet',
    nativeCurrency: { name: 'Tara', symbol: 'TARA', decimals: 18 },
    rpcUrls: ['https://rpc.mainnet.taraxa.io'],
    blockExplorerUrls: ['https://explorer.mainnet.taraxa.io']
  };

  try {
    const currentChain = await window.ethereum.request({ method: 'eth_chainId' });
    if (currentChain !== TARAXA_MAIN.chainId) {
      await window.ethereum.request({
        method: 'wallet_addEthereumChain',
        params: [TARAXA_MAIN]
      });
      console.log('‚úÖ Switched to Taraxa Mainnet');
    }
  } catch (err) {
    console.error('‚ùå Failed to switch to Taraxa network', err);
    alert('Could not switch to Taraxa network. Please add it manually.');
  }
}
</script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f8f9fa;
      max-width: 700px;
      margin: 40px auto;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    }
    h2 {
      text-align: center;
      margin-bottom: 20px;
      color: #343a40;
    }
    input, textarea, button {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      font-size: 1rem;
      border: 1px solid #ced4da;
      border-radius: 8px;
      box-sizing: border-box;
    }
    input:focus, textarea:focus {
      border-color: #0d6efd;
      outline: none;
    }
    button {
      background-color: #0d6efd;
      color: white;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    button:hover {
      background-color: #0b5ed7;
    }
    textarea {
      height: 180px;
      resize: vertical;
    }
    #status {
      margin-top: 20px;
      font-size: 0.95rem;
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #dee2e6;
      white-space: pre-wrap;
    }
    #loadingRing {
      display: none;
      margin: 20px auto;
      border: 6px solid #e9ecef;
      border-top: 6px solid #0d6efd;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    #delayWarning {
      color: #dc3545;
      font-size: 0.9rem;
      display: none;
    }
    #walletAddress {
      text-align: center;
      font-size: 0.95rem;
      margin-bottom: 10px;
    }
    #durationEstimate, #estimatedFee, #estimatedTotal {
      font-size: 0.95rem;
      color: #495057;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
	#dryRunNotice {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: #ffc107;
  color: #212529;
  padding: 10px 14px;
  border-radius: 8px;
  font-size: 0.85rem;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  z-index: 1000;
}
  </style>
</head>
<body>
<div id="dryRunNotice" style="display:none;">üöß Dry-run mode activated</div>
  <h2>üîÅ Multisend Tool</h2>
  <button onclick="connectWallet()">Connect Wallet</button>
  <div id="walletAddress"></div>
<div id="networkStatus" style="text-align:center; font-size:0.9rem; color:#198754; display:none;">‚úÖ Connected to Taraxa Mainnet</div>

  <input type="text" id="contractAddress" placeholder="ERC-20 Token Contract Address">
  <label for="amount" style="font-size: 0.9rem; color: #495057;">Amount to send per wallet (e.g. <b>1</b> = 1 token unit based on decimals)</label>
  <input type="number" id="amount" placeholder="Amount per address (token units)" value="1">
  <label for="delayInput" style="font-size: 0.9rem; color: #495057;">Delay between transactions in milliseconds (e.g. <b>300</b> = 0.3 seconds). Helps avoid rate limiting.</label>
  <input type="number" id="delayInput" placeholder="Delay between TXs (ms)" value="300">
  <div id="delayWarning">Minimum delay is 300ms for network health. Using 300ms.</div>
  <label for="recipientList" style="font-size: 0.9rem; color: #495057;">Wallet addresses to send to (one per line):</label>
  <textarea id="recipientList" placeholder="Paste wallet addresses, one per line"></textarea>
  <div id="durationEstimate"></div>
  <div id="estimatedFee">Estimated Fee (per tx): -</div>
  <div id="estimatedTotal">Estimated Total Fee: -</div>
  <button onclick="sendBulkPKEY()">üöÄ Send to All</button>

  <div id="loadingRing"></div>
  <div id="status"></div>
<script>
let dryRun = true;

window.onload = () => {
  if (dryRun) {
    document.getElementById("dryRunNotice").style.display = "block";
  }
};

let provider, signer, decimals = 18;
const abi = ["function transfer(address to, uint amount) public returns (bool)"];

async function sendBulkPKEY() {
  const contractAddress = document.getElementById("contractAddress").value.trim();
  const amount = document.getElementById("amount").value.trim();
  let delayMs = parseInt(document.getElementById("delayInput").value.trim());
  const warning = document.getElementById("delayWarning");
  const durationPreview = document.getElementById("durationEstimate");
  const rawList = document.getElementById("recipientList").value.trim();
  const recipients = rawList.split("\n").map(a => a.trim()).filter(Boolean);
  const estimatedDurationSec = Math.ceil((recipients.length * (isNaN(delayMs) || delayMs < 300 ? 300 : delayMs)) / 1000);
  durationPreview.innerText = recipients.length ? `‚è± Estimated duration: ${estimatedDurationSec} seconds` : "";
  if (isNaN(delayMs) || delayMs < 300) {
    delayMs = 300;
    warning.style.display = "block";
  } else {
    warning.style.display = "none";
  }

  const statusBox = document.getElementById("status");
  const loader = document.getElementById("loadingRing");

  if (!contractAddress || !amount || recipients.length === 0) {
    return alert("Please fill in all fields and provide recipient addresses.");
  }
  
  const isValid = recipients.every(addr => ethers.isAddress(addr));
  if (!isValid) return alert("‚ùå One or more wallet addresses are invalid.");

  if (dryRun) {
    alert(`Dry-run mode enabled. Would send ${amount} tokens to ${recipients.length} addresses.`);
    statusBox.innerText = `üöß Dry-run complete. ${amount} tokens * ${recipients.length} addresses.`;
    return;
  }

  const contract = new ethers.Contract(contractAddress, abi, signer);
  await estimateFee(contract, recipients[0], amount, recipients.length);

  loader.style.display = "block";
  let statusText = `Starting multisend to ${recipients.length} addresses...
`;
  statusBox.innerText = statusText;

  for (let i = 0; i < recipients.length; i++) {
    const to = recipients[i];
    try {
      const tx = await contract.transfer(to, ethers.parseUnits(amount, decimals));
      statusText += `‚è≥ [${i + 1}/${recipients.length}] Tx sent to ${to}: ${tx.hash}
`;
      statusBox.innerText = statusText;
      await tx.wait();
      statusText += `‚úÖ Confirmed: ${tx.hash}
`;
    } catch (e) {
      statusText += `‚ùå Failed for ${to}: ${e.message}
`;
    }
    statusBox.innerText = statusText;
    await new Promise(resolve => setTimeout(resolve, delayMs));
  }

  loader.style.display = "none";
  statusText += `
üéâ Done sending to ${recipients.length} addresses.`;
  statusBox.innerText = statusText;
}

async function connectWallet() {
  await setupTaraxaNetwork();

  let ethProvider;

  if (window.enkrypt?.providers?.ethereum) {
    ethProvider = window.enkrypt.providers.ethereum;
    console.log("‚úÖ Enkrypt detected");
  } else if (window.ethereum) {
    ethProvider = window.ethereum;
    console.warn("‚ö†Ô∏è Enkrypt not found. Falling back to MetaMask.");
  } else {
    alert("No compatible wallet found (Enkrypt or MetaMask).");
    return;
  }

  provider = new ethers.BrowserProvider(ethProvider);
  await provider.send("eth_requestAccounts", []);
  signer = await provider.getSigner();

  const address = await signer.getAddress();
  document.getElementById("walletAddress").innerText = "Sender: " + address;
  document.getElementById("networkStatus").style.display = "block";
}

async function getTokenInfo(address) {
  const erc20Abi = [
    "function name() view returns (string)",
    "function symbol() view returns (string)",
    "function decimals() view returns (uint8)"
  ];
  try {
    const contract = new ethers.Contract(address, erc20Abi, provider);
    const name = await contract.name();
    const symbol = await contract.symbol();
    decimals = await contract.decimals();
    return { name, symbol, decimals };
  } catch (err) {
    console.error("Failed to fetch token info", err);
    return null;
  }
}

document.getElementById("contractAddress").addEventListener("blur", async () => {
  const address = document.getElementById("contractAddress").value.trim();
  if (!ethers.isAddress(address)) return;
  if (!provider) return;
  const info = await getTokenInfo(address);
  if (info) {
    document.getElementById("amount").placeholder = `Amount per address (${info.symbol})`;
    document.title = `${info.name} Multisend Tool`;
  }
});

async function estimateFee(contract, recipient, amount, count) {
  try {
    const tx = await contract.transfer(recipient, ethers.parseUnits(amount, decimals));
    const feePerTx = tx.gasLimit * tx.maxFeePerGas;
    document.getElementById("estimatedFee").innerText = `Estimated Fee (per tx): ${ethers.formatEther(feePerTx)} TARA`;
    document.getElementById("estimatedTotal").innerText = `Estimated Total Fee: ~${ethers.formatEther(feePerTx * BigInt(count))} TARA`;
  } catch (e) {
    console.warn("Fee estimate failed:", e.message);
  }
}

</script>
</body>
</html>
