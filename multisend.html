<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Multisend Tool - Working Example</title>

<!-- Ethers.js -->
<script src="https://cdn.jsdelivr.net/npm/ethers@6.8.1/dist/ethers.umd.min.js"></script>

<!-- Web3Modal v2 -->
<script src="https://unpkg.com/@web3modal/html@2.3.4/dist/index.min.js"></script>
<script src="https://unpkg.com/@web3modal/ethereum@2.3.4/dist/index.min.js"></script>

<!-- Wagmi Core -->
<script src="https://unpkg.com/@wagmi/core@0.10.1/dist/index.min.js"></script>

<style>
  body {
    max-width: 700px; margin: 40px auto; font-family: 'Segoe UI', sans-serif;
    background-color: #f8f9fa; padding: 30px; border-radius: 16px; box-shadow: 0 6px 20px rgba(0,0,0,0.1);
  }
  h2 { text-align: center; margin-bottom: 20px; color: #343a40; }
  input, textarea, button { width: 100%; padding: 12px; margin: 10px 0; font-size: 1rem; border: 1px solid #ced4da; border-radius: 8px; box-sizing: border-box; }
  button { background-color: #0d6efd; color: white; cursor: pointer; border: none; transition: background-color 0.2s; }
  button:hover { background-color: #0b5ed7; }
  textarea { height: 180px; resize: vertical; }
  #status { margin-top: 20px; font-size: 0.95rem; background: #fff; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6; white-space: pre-wrap; }
</style>
</head>
<body>

<h2>üîÅ Multisend Tool</h2>

<button id="connectBtn">Connect Wallet</button>
<div id="walletAddress"></div>
<div id="networkStatus" style="color: green; display: none;">‚úÖ Connected to Taraxa Mainnet</div>

<input type="text" id="contractAddress" placeholder="ERC-20 Token Contract Address" />
<input type="number" id="amount" placeholder="Amount per address (token units)" value="1" />
<textarea id="recipientList" placeholder="Paste wallet addresses, one per line"></textarea>

<button id="sendBtn">üöÄ Send to All</button>

<div id="status"></div>

<script>
  // Required globals from loaded scripts
  const { w3mConnectors, w3mProvider, EthereumClient } = window.WagmiCore;
  const { Web3Modal } = window.Web3Modal;

  const chains = [
    {
      id: 841,
      name: "Taraxa Mainnet",
      network: "taraxa",
      nativeCurrency: { decimals: 18, name: "Tara", symbol: "TARA" },
      rpcUrls: {
        default: ["https://rpc.mainnet.taraxa.io"]
      },
      blockExplorers: {
        default: { name: "Taraxa Explorer", url: "https://explorer.mainnet.taraxa.io" }
      }
    }
  ];

  const projectId = "c3bca9309d970d96c70be0b04f661798";

  // Wagmi provider and connectors
  const wagmiProvider = w3mProvider({ projectId, chains });
  const wagmiConnectors = w3mConnectors({ projectId, chains });

  // Ethereum client bridge for Web3Modal
  const ethereumClient = new EthereumClient(wagmiProvider, wagmiConnectors);

  // Initialize Web3Modal with Ethereum client
  const web3Modal = new Web3Modal({
    projectId,
    ethereumClient,
    themeMode: "light"
  });

  let provider, signer, decimals = 18;

  // Connect wallet function
  async function connectWallet() {
    try {
      await web3Modal.open();
      // Use ethereumClient.getProvider() for ethers provider
      provider = new ethers.BrowserProvider(ethereumClient.getProvider());
      await provider.send("eth_requestAccounts", []);
      signer = await provider.getSigner();
      const address = await signer.getAddress();

      document.getElementById("walletAddress").innerText = "Connected: " + address;
      document.getElementById("networkStatus").style.display = "block";
      logStatus("Wallet connected: " + address);
    } catch (err) {
      logStatus("Connection failed: " + err.message);
      alert("Failed to connect wallet. See console for details.");
      console.error(err);
    }
  }

  // Simple function to update status box
  function logStatus(msg) {
    const statusBox = document.getElementById("status");
    statusBox.innerText += msg + "\n";
  }

  // Send tokens in bulk
  async function sendBulkPKEY() {
    const contractAddress = document.getElementById("contractAddress").value.trim();
    const amount = document.getElementById("amount").value.trim();
    const rawList = document.getElementById("recipientList").value.trim();
    const recipients = rawList.split("\n").map(a => a.trim()).filter(Boolean);

    if (!provider || !signer) {
      alert("Please connect your wallet first.");
      return;
    }

    if (!contractAddress || !amount || recipients.length === 0) {
      alert("Please fill in all fields and provide recipient addresses.");
      return;
    }

    if (!recipients.every(addr => ethers.isAddress(addr))) {
      alert("One or more wallet addresses are invalid.");
      return;
    }

    logStatus(`Sending ${amount} tokens to ${recipients.length} addresses...`);

    const contract = new ethers.Contract(
      contractAddress,
      ["function transfer(address to, uint amount) public returns (bool)"],
      signer
    );

    for (let i = 0; i < recipients.length; i++) {
      const to = recipients[i];
      try {
        const tx = await contract.transfer(to, ethers.parseUnits(amount, decimals));
        logStatus(`Tx sent to ${to}: ${tx.hash}`);
        await tx.wait();
        logStatus(`Tx confirmed: ${tx.hash}`);
      } catch (e) {
        logStatus(`Failed for ${to}: ${e.message}`);
      }
      // Small delay between txs to avoid rate limits
      await new Promise(r => setTimeout(r, 500));
    }

    logStatus("Done sending tokens.");
  }

  // Wire button clicks
  document.getElementById("connectBtn").onclick = connectWallet;
  document.getElementById("sendBtn").onclick = sendBulkPKEY;

</script>

</body>
</html>
